---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import HeroHeader from '../components/HeroHeader.astro';
import SearchModal from '../components/SearchModal.astro';
import { heroConfig, locale, profileConfig, siteTitle } from '../config';
import katexStylesheetUrl from 'katex/dist/katex.min.css?url';

interface Heading {
	depth: number;
	slug: string;
	text: string;
}

interface Props extends CollectionEntry<'blog'>['data'] {
	headings?: Heading[];
	wordCount?: number;
	readingTime?: number;
	seoDescription?: string;
	loadKatexStyles?: boolean;
}

const {
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	categories,
	tags,
	headings = [],
	wordCount,
	readingTime,
	seoDescription,
	loadKatexStyles = false,
} = Astro.props;
const metaDescription = (seoDescription || description || title).trim();
const siteURL = Astro.site ?? Astro.url;
const canonicalURL = new URL(Astro.url.pathname, siteURL).toString();

// 使用配置中的文章默认背景图
const defaultHeroImage = heroConfig.postDefaultBackground;
const displayHeroImage = heroImage || defaultHeroImage;
const displayHeroImageSrc = typeof displayHeroImage === 'string' ? displayHeroImage : displayHeroImage.src;
const articleSection =
	Array.isArray(categories) && categories.length > 0
		? categories[0]
		: typeof categories === 'string'
			? categories
			: undefined;
const articleTags = Array.isArray(tags) ? tags : [];
const authorName = profileConfig.name || siteTitle;
const authorUrl = new URL('/about/', siteURL).toString();
const articleSchema = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	'@id': `${canonicalURL}#article`,
	mainEntityOfPage: canonicalURL,
	headline: title,
	description: metaDescription,
	datePublished: pubDate.toISOString(),
	...(updatedDate ? { dateModified: updatedDate.toISOString() } : {}),
	author: {
		'@type': 'Person',
		name: authorName,
		url: authorUrl,
	},
	publisher: {
		'@type': 'Person',
		name: authorName,
		url: authorUrl,
	},
	image: [new URL(displayHeroImageSrc, siteURL).toString()],
	inLanguage: locale,
	...(articleTags.length > 0 ? { keywords: articleTags.join(', ') } : {}),
};

// 构建完整的层级树结构
interface TocNode {
	heading: Heading;
	children: TocNode[];
}

function buildTocTree(headings: Heading[]): TocNode[] {
	const root: TocNode[] = [];
	const stack: { node: TocNode; depth: number }[] = [];
	
	for (const heading of headings) {
		const node: TocNode = { heading, children: [] };
		
		// 向上查找合适的父节点
		while (stack.length > 0 && stack[stack.length - 1].depth >= heading.depth) {
			stack.pop();
		}
		
		if (stack.length === 0) {
			root.push(node);
		} else {
			stack[stack.length - 1].node.children.push(node);
		}
		
		stack.push({ node, depth: heading.depth });
	}
	
	return root;
}

const tocTree = buildTocTree(headings);
---

<html lang="zh-CN">
	<head>
		<BaseHead
			title={title}
			description={metaDescription}
			image={displayHeroImage}
			type="article"
			publishedTime={pubDate}
			modifiedTime={updatedDate}
			section={articleSection}
			tags={articleTags}
			schema={articleSchema}
		/>
		<link rel="preload" as="image" href={displayHeroImageSrc} />
		{loadKatexStyles && (
			<>
				<link rel="preload" as="style" href={katexStylesheetUrl} />
				<link rel="stylesheet" href={katexStylesheetUrl} media="print" onload="this.media='all'" />
				<noscript>
					<link rel="stylesheet" href={katexStylesheetUrl} />
				</noscript>
			</>
		)}
		<style>
			
            
            /* Hero Meta Custom Styles */
            .hero-meta {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 0.8em;
				font-size: 0.9em;
				opacity: 0.9;
				text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                margin-top: 1em;
                color: white;
			}
			
			.meta-row {
				display: flex;
				gap: 1.5em;
				align-items: center;
				justify-content: center;
			}
			
			.meta-item {
				display: flex;
				align-items: center;
				gap: 0.4em;
			}

			/* 布局容器 */
			.layout-container {
				display: grid;
				grid-template-columns: 1fr 260px;
				gap: 60px;
				max-width: 1400px;
				margin: 0 auto;
				padding: 0 1em 2em;
				position: relative;
				z-index: 20;
			}
			
			/* 内容卡片样式 */
			.content-card {
				background: var(--color-surface);
				border-radius: 16px;
				box-shadow: var(--shadow-card);
				padding: 3em;
				min-height: 300px;
				width: 100%;
				animation: slideUp 0.5s ease-out forwards;
				opacity: 0; /* 初始隐藏 */
				transform: translateY(30px); /* 初始下移 */
				min-width: 0; /* 修复：防止 Grid Item 被内部宽元素（如代码块）撑大 */
				will-change: transform, opacity;
			}

			@keyframes slideUp {
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			/* 侧边栏容器 */
			.sidebar-container {
				padding-top: 100px; /* 初始位置下移，避开图片 */
			}

			.slide-in-right {
				animation: slideInRight 0.5s ease-out forwards;
				opacity: 0;
				transform: translateX(20px);
				animation-delay: 0.2s; /* 稍微延迟等待主内容 */
				will-change: transform, opacity;
			}

			@keyframes slideInRight {
				to {
					opacity: 1;
					transform: translateX(0);
				}
			}
			
			/* 粘性 TOC */
			.sticky-toc {
				position: sticky;
				top: 20px;
				max-height: calc(100vh - 40px);
				overflow-y: auto;
				/* 移除卡片样式 */
				background: transparent;
				border: none;
				box-shadow: none;
				padding: 0;
			}
            
            /* Custom Scrollbar for TOC */
            .sticky-toc::-webkit-scrollbar { width: 4px; }
			.sticky-toc::-webkit-scrollbar-thumb { background: var(--color-scrollbar); border-radius: 2px; }

			.toc-sidebar {
				width: 100%;
			}
			
			/* 目录标题 */
			.toc-title {
				font-size: 1.1em;
				font-weight: 700;
				color: var(--color-text);
				margin-bottom: 0.8em;
				display: flex;
				align-items: center;
				gap: 0.5em;
			}
			
			/* 列表基础样式 */
			.toc-list { list-style: none; padding: 0; margin: 0; }
			.toc-item { position: relative; }
			
			/* 链接样式 */
			.toc-link {
				display: block;
				padding: 4px 0 4px 12px;
				color: var(--color-text-secondary);
				text-decoration: none;
				border-left: 2px solid var(--color-border);
				transition: color 0.2s ease, border-left-color 0.2s ease;
				line-height: 1.4;
				font-size: 0.95em;
			}
			
			.toc-link:hover {
				color: var(--accent);
				border-left-color: rgba(var(--accent), 0.5);
			}
			
			/* 激活状态：蓝色左边框 */
			.toc-link.active {
				color: var(--accent);
				border-left-color: var(--accent);
				font-weight: 600;
				background: transparent; /* 移除背景色 */
			}
			
			.toc-text {
				display: block;
			}
			
			/* 子列表 */
			.toc-children {
				list-style: none;
				padding-left: 0; /* 对齐父级 */
				margin: 0;
				overflow: hidden;
				max-height: 0;
				opacity: 0;
				transition: all 0.3s ease-in-out;
			}
			
			/* 展开状态 */
			.toc-item.expanded > .toc-children {
				max-height: 1000px; /* 足够大以显示内容 */
				opacity: 1;
				margin-top: 4px;
				margin-bottom: 4px;
			}
			
			/* 层级样式 - 通过 padding-left 控制缩进 */
			.toc-item[data-depth="2"] > .toc-link { padding-left: 24px; }
			.toc-item[data-depth="3"] > .toc-link { padding-left: 36px; font-size: 0.9em; }
			.toc-item[data-depth="4"] > .toc-link { padding-left: 48px; font-size: 0.85em; }
			
			/* 响应式调整 */
			@media (max-width: 1100px) { 
				.layout-container {
					grid-template-columns: 1fr; /* 单列布局 */
					max-width: 960px;
					gap: 24px;
					padding: 0 0.75em 1.5em;
				}
				.sidebar-container { 
					display: none; /* 窄屏隐藏右侧栏 */
				}
				.content-card {
					padding: 2.1em 1.6em;
				}
			}
			
			/* 自动编号样式 */
			#toc-root {
				counter-reset: level1;
			}
			
			/* 第一级: 第一章 */
			#toc-root > .toc-item {
				counter-increment: level1;
			}
			
			#toc-root > .toc-item > .toc-link .toc-text::before {
				content: "第" counter(level1, cjk-decimal) "章 ";
				color: var(--color-text-tertiary);
				font-weight: normal;
				margin-right: 4px;
				font-size: 0.9em;
			}
			
			/* 第二级: 1.1 */
			#toc-root > .toc-item > .toc-children {
				counter-reset: level2;
			}
			
			#toc-root > .toc-item > .toc-children > .toc-item {
				counter-increment: level2;
			}
			
			#toc-root > .toc-item > .toc-children > .toc-item > .toc-link .toc-text::before {
				content: counter(level1) "." counter(level2) " ";
				color: var(--color-text-tertiary);
				font-weight: normal;
				margin-right: 4px;
				font-size: 0.9em;
			}
			
			/* 第三级: 1.1.1 */
			#toc-root > .toc-item > .toc-children > .toc-item > .toc-children {
				counter-reset: level3;
			}
			
			#toc-root > .toc-item > .toc-children > .toc-item > .toc-children > .toc-item {
				counter-increment: level3;
			}
			
			#toc-root > .toc-item > .toc-children > .toc-item > .toc-children > .toc-item > .toc-link .toc-text::before {
				content: counter(level1) "." counter(level2) "." counter(level3) " ";
				color: var(--color-text-tertiary);
				font-weight: normal;
				margin-right: 4px;
				font-size: 0.9em;
			}
			
				@media (max-width: 768px) {
					.hero-meta {
						font-size: 0.82em;
						gap: 0.55em;
						padding: 0 1em;
						margin-top: 0.75em;
					}

					.layout-container {
						padding: 0 0 1.5em;
						gap: 0;
					}

					.meta-row {
						gap: 0.85em;
						flex-wrap: wrap;
					}

					.content-card {
						padding: 1.2em 1em;
						border-radius: 0;
						box-sizing: border-box;
					}

				.meta-item svg {
					width: 16px;
					height: 16px;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<div id="main-content">
		
		<!-- Hero Header with injected content -->
		<HeroHeader 
            text={title} 
            backgroundImage={displayHeroImageSrc}
            compact={true}
        >
            <div class="hero-meta">
                <div class="meta-row">
                    <div class="meta-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <FormattedDate date={pubDate} />
                    </div>
                </div>
                <div class="meta-row">
                    {wordCount && (
                        <div class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                            <span>{wordCount} 字</span>
                        </div>
                    )}
                    {readingTime && (
                        <div class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            <span>{readingTime} 分钟</span>
                        </div>
                    )}
                </div>
            </div>
        </HeroHeader>
		
		<div class="stats-wrapper">
			<div class="layout-container">
				<main class="content-card" transition:name="page-content">
					<article>
						<div class="prose">
							<slot />
							{updatedDate && (
								<div class="last-updated-on">
									Last updated on <FormattedDate date={updatedDate} />
								</div>
							)}
						</div>
					</article>
				</main>
				
				{tocTree.length > 0 && (
					<aside class="sidebar-container slide-in-right">
						<nav class="toc-sidebar sticky-toc" id="toc">
							<div class="toc-title">
								<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
									<path d="M3 6h18M3 12h18M3 18h18" />
								</svg>
								目录
							</div>
							<ul class="toc-list" id="toc-root">
								{tocTree.map((node) => (
									<li class="toc-item" data-depth={node.heading.depth} data-slug={node.heading.slug}>
										<a href={`#${node.heading.slug}`} class="toc-link">
											<span class="toc-text">{node.heading.text}</span>
										</a>
										{node.children.length > 0 && (
											<ul class="toc-children">
												{node.children.map((child) => (
													<li class="toc-item" data-depth={child.heading.depth} data-slug={child.heading.slug}>
														<a href={`#${child.heading.slug}`} class="toc-link">
															<span class="toc-text">{child.heading.text}</span>
														</a>
														{child.children.length > 0 && (
															<ul class="toc-children">
																{child.children.map((grandchild) => (
																	<li class="toc-item" data-depth={grandchild.heading.depth} data-slug={grandchild.heading.slug}>
																		<a href={`#${grandchild.heading.slug}`} class="toc-link">
																			<span class="toc-text">{grandchild.heading.text}</span>
																		</a>
																		{grandchild.children.length > 0 && (
																			<ul class="toc-children">
																				{grandchild.children.map((ggc) => (
																					<li class="toc-item" data-depth={ggc.heading.depth} data-slug={ggc.heading.slug}>
																						<a href={`#${ggc.heading.slug}`} class="toc-link">
																							<span class="toc-text">{ggc.heading.text}</span>
																						</a>
																					</li>
																				))}
																			</ul>
																		)}
																	</li>
																))}
															</ul>
														)}
													</li>
												))}
											</ul>
										)}
									</li>
								))}
							</ul>
						</nav>
					</aside>
				)}
			</div>
		</div>
		
		<Footer />
        </div>
		
		<SearchModal />
		
		<!-- Lightbox HTML -->
		<div id="lightbox" class="lightbox-overlay">
			<span class="lightbox-close">&times;</span>
			<img class="lightbox-image" src="" alt="Lightbox">
		</div>

        <script>
            import { setupToc } from '../scripts/toc';
            import { setupCodeBlocks } from '../scripts/code-block';
            import { setupLightbox } from '../scripts/lightbox';

            const runEnhancements = () => {
                setupToc?.();
                setupCodeBlocks?.();
                setupLightbox?.();
            };

            if (window.__blogEnhancementsHandler) {
                document.removeEventListener('astro:page-load', window.__blogEnhancementsHandler);
            }
            window.__blogEnhancementsHandler = runEnhancements;
            document.addEventListener('astro:page-load', runEnhancements);
            runEnhancements();
        </script>
	</body>
</html>

