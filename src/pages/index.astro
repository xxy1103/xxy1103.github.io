---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import HeroHeader from '../components/HeroHeader.astro';
import FormattedDate from '../components/FormattedDate.astro';
import SearchModal from '../components/SearchModal.astro';
import { heroConfig, locale, siteDescription, siteTitle } from '../config';
import { getCollection } from 'astro:content';
import { existsSync } from 'node:fs';

const posts = (await getCollection('blog')).filter((post) =>
    post.filePath ? existsSync(post.filePath) : false
);
const siteURL = Astro.site ?? Astro.url;
const postCount = posts.length;
const wordCount = posts.reduce((acc, post) => acc + (post.body ? post.body.length : 0), 0);
const tagCount = new Set(posts.flatMap(post => post.data.tags || [])).size;
const sortedAscPosts = [...posts].sort((a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf());
const startDate = postCount > 0 ? sortedAscPosts[0].data.pubDate : null;
const recentPosts = [...posts].sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()).slice(0, 10);
const hasPosts = postCount > 0;
const homeHero = heroConfig.home;
const webSiteSchema = {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    '@id': new URL('/#website', siteURL).toString(),
    url: new URL('/', siteURL).toString(),
    name: siteTitle,
    description: siteDescription,
    inLanguage: locale
};

// Format word count (e.g. 5.26万)
function formatWordCount(count: number) {
    if (count > 10000) {
        return (count / 10000).toFixed(2) + ' 万';
    }
    return count.toString();
}

function formatDate(date: Date) {
    return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={siteTitle} description={siteDescription} schema={webSiteSchema} />
		<style>
            html, body {
                height: 100%;
                margin: 0;
            }
            main {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Stats Section Wrapper */
            .stats-wrapper {
                position: relative;
                background: var(--color-bg);
                min-height: 50vh;
                /* padding-top: 80px; Space for overlap if needed */
            }

            /* Content Card - Animation handled by ViewTransitions */
            .content-card {
                position: relative;
                z-index: 20;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 1em 2em;
            }

            /* Stats Container - matches blog posts-container */
            .stats-container {
                background: var(--color-surface);
                border-radius: 16px;
                box-shadow: var(--shadow-card);
                padding: 2em;
            }

            .section-header {
                display: flex;
                align-items: baseline;
                gap: 0.5em;
                margin-bottom: 0.5em;
            }

            .section-number {
                font-size: 0.9em;
                color: var(--color-text-muted);
                font-weight: 500;
            }

            .section-title {
                font-size: 1.8em;
                font-weight: bold;
                margin: 0;
                color: var(--color-text);
            }

            .intro-text {
                color: var(--color-text-secondary);
                margin-bottom: 2em;
                font-size: 0.9em;
                line-height: 1.6;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1px;
                background: var(--color-border);
                border: 1px solid var(--color-border);
                margin-bottom: 2em;
            }

            .stat-item {
                background: var(--color-surface);
                padding: 2em;
                text-align: center;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            .stat-item:hover {
                transform: translateY(-5px);
                z-index: 1;
                box-shadow: var(--shadow-card-hover);
            }

            .stat-value {
                font-size: 2em;
                font-weight: bold;
                color: var(--color-text-strong);
                margin-bottom: 0.2rem;
                font-variant-numeric: tabular-nums;
            }

            .stat-label {
                color: var(--color-text-secondary);
                font-size: 0.9em;
                font-weight: bold;
            }

            .blog-link {
                display: block;
                text-align: center;
                color: var(--color-text);
                text-decoration: none;
                font-weight: bold;
                font-size: 0.9em;
                transition: all 0.3s;
            }
            .blog-link:hover {
                color: var(--accent);
            }
            /* Move arrow on hover logic will be handled via span or text change if needed, 
               but simpler is to rely on color change or generic transform */

            /* Recent Posts Section */
            .recent-posts-section {
                margin-top: 3em;
                padding-top: 2em;
                border-top: 1px solid var(--color-border);
            }

            .posts-list .post-item {
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            }

            /* Triggered when list becomes visible */
            .posts-list.visible .post-item {
                opacity: 1;
                transform: translateY(0);
            }
            
            /* Stagger delays */
            .posts-list.visible .post-item:nth-child(1) { transition-delay: 0.1s; }
            .posts-list.visible .post-item:nth-child(2) { transition-delay: 0.2s; }
            .posts-list.visible .post-item:nth-child(3) { transition-delay: 0.3s; }
            .posts-list.visible .post-item:nth-child(4) { transition-delay: 0.4s; }
            .posts-list.visible .post-item:nth-child(5) { transition-delay: 0.5s; }
            .posts-list.visible .post-item:nth-child(6) { transition-delay: 0.6s; }
            .posts-list.visible .post-item:nth-child(7) { transition-delay: 0.7s; }
            .posts-list.visible .post-item:nth-child(8) { transition-delay: 0.8s; }
            .posts-list.visible .post-item:nth-child(9) { transition-delay: 0.9s; }
            .posts-list.visible .post-item:nth-child(10) { transition-delay: 1.0s; }

            .post-item {
                padding: 1.2em 0;
                border-bottom: 1px solid var(--color-border-subtle);
                transition: background 0.2s, transform 0.2s;
            }

            .post-item:last-child {
                border-bottom: none;
            }

            .post-item:hover {
                background: var(--color-surface-elevated);
                margin: 0 -1em;
                padding-left: 1em;
                padding-right: 1em;
                border-radius: 8px;
            }

            .post-title {
                font-size: 1.2em;
                font-weight: 600;
                margin: 0 0 0.5em 0;
            }

            .post-title a {
                color: var(--color-text);
                text-decoration: none;
                display: inline;
                background-image: linear-gradient(var(--accent), var(--accent));
                background-position: 0% 100%;
                background-repeat: no-repeat;
                background-size: 0% 2px;
                transition: background-size 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), color 0.3s ease;
                padding-bottom: 2px;
            }

            .post-item:hover .post-title a {
                color: var(--accent);
                background-size: 100% 2px;
                /* transform: translateX(0);  Removed simple shift */
            }

            .post-meta {
                display: flex;
                align-items: center;
                gap: 1em;
                font-size: 0.85em;
                color: var(--color-text-tertiary);
                flex-wrap: wrap;
            }

            .home-post-meta-item {
                display: flex;
                align-items: center;
                gap: 0.3em;
            }

            .home-post-meta-item svg {
                width: 14px;
                height: 14px;
            }

            .post-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 0.4em;
            }

            .tag-link {
                display: inline-flex;
                align-items: center;
                gap: 0.2em;
                padding: 2px 8px;
                background: var(--color-tag-bg);
                color: var(--color-tag-text);
                text-decoration: none;
                border-radius: 4px;
                font-size: 0.85em;
                transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
                transform-origin: center;
            }

            .tag-link:hover {
                background: var(--accent);
                color: white;
                transform: translateY(-2px) scale(1.05);
                box-shadow: 0 3px 8px rgba(var(--accent-rgb), 0.25);
            }

            .tag-link:active {
                transform: translateY(0) scale(0.97);
            }

            .tag-link svg {
                width: 12px;
                height: 12px;
            }

            .empty-state {
                margin: 1.2em 0;
                color: var(--color-text-secondary);
                font-size: 0.95em;
                line-height: 1.7;
                text-align: center;
                padding: 1.4em;
                border: 1px dashed var(--color-border);
                border-radius: 12px;
                background: var(--color-surface-elevated);
            }

				@media (max-width: 720px) {
					.hero-title { font-size: 1.5em; }
	                .content-card {
	                    padding: 0;
	                }
	                .stats-grid {
	                    grid-template-columns: 1fr;
	                }
	                .stats-container {
	                    padding: 1.5em;
	                    border-radius: 0;
	                }
				}
			</style>
	</head>
	<body>
		<Header transparent={true} />
        <div id="main-content">
		<main>
            <!-- Hero Header -->
            <HeroHeader
                text={homeHero.text}
                subtitle={homeHero.subtitle}
                backgroundImage={homeHero.backgroundImage}
                interactive={true}
            />

            <!-- Stats Section -->
            <div class="stats-wrapper">
                <div class="content-card" id="stats-card" transition:name="page-content">
                    <div class="stats-container">
                        <div class="section-header">
                            <span class="section-number">01</span>
                        </div>
                        <h2 class="section-title">文章</h2>
                        <p class="intro-text">
                            {hasPosts
                                ? `从 ${formatDate(startDate!)} 的第一篇文章开始，本站已经更新了......`
                                : '当前模板未附带文章内容，你可以在 src/content/blog/ 中添加 Markdown 文章后自动显示统计与列表。'}
                        </p>
                        
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value">{postCount} 篇</span>
                                <span class="stat-label">文章</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{formatWordCount(wordCount)}</span>
                                <span class="stat-label">字数</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{tagCount} 个</span>
                                <span class="stat-label">标签</span>
                            </div>
                        </div>

                        <!-- Recent Posts Section -->
                        <div class="recent-posts-section">
                            <div class="section-header">
                                <span class="section-number">02</span>
                            </div>
                            <h2 class="section-title">最近更新</h2>
                            <p class="intro-text">{hasPosts ? '最新发布的 10 篇文章' : '暂无文章可展示'}</p>
                            
                            {recentPosts.length > 0 ? (
                                <>
                                    <div class="posts-list">
                                    {recentPosts.map((post) => (
                                        <article class="post-item">
                                            <h3 class="post-title">
                                                <a href={`/blog/${post.id}/`}>{post.data.title}</a>
                                            </h3>
                                            <div class="post-meta">
                                                <div class="home-post-meta-item">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                                    </svg>
                                                    <FormattedDate date={post.data.pubDate} />
                                                </div>
                                                {post.data.categories && (
                                                    <div class="home-post-meta-item">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                                        </svg>
                                                        <span>{post.data.categories}</span>
                                                    </div>
                                                )}
                                                {post.data.tags && post.data.tags.length > 0 && (
                                                    <div class="post-tags">
                                                        {post.data.tags.slice(0, 3).map((tag: string) => (
                                                            <a href={`/tags/${encodeURIComponent(tag)}/`} class="tag-link hover-scale">
                                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                                                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                                                </svg>
                                                                #{tag}
                                                            </a>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </article>
                                    ))}
                                    </div>
                                    <a href="/blog" class="blog-link" style="margin-top: 1em;">查看全部文章 ⇗</a>
                                </>
                            ) : (
                                <p class="empty-state">
                                    这里还没有文章。请在 <code>src/content/blog/</code> 新建 <code>.md</code> 或 <code>.mdx</code> 文件。
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Animation Utilities
                document.addEventListener('astro:page-load', () => {
                    const statsCard = document.getElementById('stats-card');
                    const heroHeader = document.querySelector('.hero-header');
                    const mainContent = document.getElementById('main-content'); // Get scroll container
                    const isCoarsePointer = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
                    const maxRise = isCoarsePointer ? 48 : 100;

                    // 1. Parallax & Slide-up Reset (ensure clean state)
                    if (statsCard) {
                        statsCard.style.opacity = '1';
                        statsCard.style.transform = 'translateY(0)';
                    }

                    if (statsCard && heroHeader && mainContent) {
                        let ticking = false;
                        function updateParallax() {
                            const heroBottom = (heroHeader as HTMLElement).offsetTop + (heroHeader as HTMLElement).offsetHeight;
                            const scrollY = mainContent!.scrollTop; // Use container scroll
                            const scrollStart = heroBottom - window.innerHeight;
                            
                            if (scrollY > scrollStart) {
                                const progress = Math.min((scrollY - scrollStart) / (window.innerHeight * 0.5), 1);
                                const rise = progress * maxRise;
                                statsCard.style.transform = `translateY(-${rise}px)`;
                            } else {
                                statsCard.style.transform = 'translateY(0)';
                            }
                        }

                        const onScroll = () => {
                            if (ticking) return;
                            ticking = true;
                            requestAnimationFrame(() => {
                                updateParallax();
                                ticking = false;
                            });
                        };

                        const mainContentAny = mainContent as any;
                        if (mainContentAny.__homeParallaxHandler) {
                            mainContent.removeEventListener('scroll', mainContentAny.__homeParallaxHandler);
                        }

                        mainContentAny.__homeParallaxHandler = onScroll;
                        updateParallax();
                        mainContent.addEventListener('scroll', onScroll, { passive: true });
                    }

                    // 2. Number Count-up Animation
                    const statValues = document.querySelectorAll('.stat-value');
                    const countUpObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const target = entry.target;
                                const originalText = target.innerText;
                                const match = originalText.match(/([\d\.]+)(.*)/); // Split number and suffix
                                if (match) {
                                    const numberPart = parseFloat(match[1]);
                                    const suffix = match[2];
                                    const isFloat = match[1].includes('.');
                                    
                                    let start = 0;
                                    const duration = 1500;
                                    const startTime = performance.now();

                                    function update(currentTime: number) {
                                        const elapsed = currentTime - startTime;
                                        const progress = Math.min(elapsed / duration, 1);
                                        // Ease out cubic
                                        const ease = 1 - Math.pow(1 - progress, 3);
                                        
                                        const current = numberPart * ease;
                                        // Format based on original precision
                                        const formatted = isFloat ? current.toFixed(2) : Math.floor(current).toString();
                                        
                                        target.innerText = formatted + suffix;

                                        if (progress < 1) {
                                            requestAnimationFrame(update);
                                        } else {
                                            target.innerText = originalText; // Ensure exact final value
                                        }
                                    }
                                    requestAnimationFrame(update);
                                }
                                countUpObserver.unobserve(target);
                            }
                        });
                    }, { threshold: 0.5 });
                    
                    statValues.forEach(el => countUpObserver.observe(el));

                    // 3. Staggered Post Entry
                    const postsList = document.querySelector('.posts-list');
                    
                    if (postsList) {
                        const postsObserver = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    postsList.classList.add('visible');
                                    postsObserver.unobserve(entry.target);
                                }
                            });
                        }, { threshold: 0.1 });
                        
                        postsObserver.observe(postsList);
                    }
                });
            </script>
		</main>
		<Footer />
        </div>
		<SearchModal />
	</body>
</html>
