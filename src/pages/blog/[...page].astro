---
import type { GetStaticPaths, Page } from 'astro';
import ContentCard from '../../components/ContentCard.astro';
import HeroHeader from '../../components/HeroHeader.astro';
import PageShell from '../../layouts/PageShell.astro';
import PostListItem from '../../components/PostListItem.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import { heroConfig, siteTitle } from '../../config';
import { getBlogPosts, type BlogPost } from '../../lib/content/blog';
import { extractExcerpt } from '../../lib/content/text';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const posts = await getBlogPosts();

  if (posts.length === 0) {
    return [
      {
        params: { page: undefined },
        props: {
          page: {
            data: [],
            start: 0,
            end: 0,
            size: 15,
            total: 0,
            currentPage: 1,
            lastPage: 1,
            url: {
              current: '/blog',
              prev: undefined,
              next: undefined,
            },
          },
        },
      },
    ];
  }

  return paginate(posts, { pageSize: 15 });
};

const { page } = Astro.props as { page: Page<BlogPost> };
const siteURL = Astro.site ?? Astro.url;
const hasPosts = page.total > 0;
const blogHero = heroConfig.blog;
const pageTitle =
  !hasPosts || page.currentPage === 1
    ? `博客 | ${siteTitle}`
    : `博客 - 第 ${page.currentPage} 页 | ${siteTitle}`;
const pageDescription =
  !hasPosts
    ? '当前模板未附带文章内容，你可以在 src/content/blog/ 中添加 Markdown 后自动生成列表。'
    : page.currentPage === 1
    ? `按发布时间倒序浏览全部 ${page.total} 篇文章。`
    : `博客归档第 ${page.currentPage} 页（共 ${page.lastPage} 页），收录 ${page.total} 篇文章。`;
const shouldNoindex = page.currentPage > 1;
const canonicalPath = page.currentPage === 1 ? '/blog/' : `/blog/${page.currentPage}/`;
const canonicalURL = new URL(canonicalPath, siteURL);
const prevURL = page.url.prev ? new URL(page.url.prev, siteURL).toString() : undefined;
const nextURL = page.url.next ? new URL(page.url.next, siteURL).toString() : undefined;

const current = page.currentPage;
const last = page.lastPage;
const delta = 2;
const paginationList: Array<number | '...'> = [];
const rangeStart = Math.max(2, current - delta);
const rangeEnd = Math.min(last - 1, current + delta);

paginationList.push(1);
if (rangeStart > 2) paginationList.push('...');
for (let i = rangeStart; i <= rangeEnd; i += 1) paginationList.push(i);
if (rangeEnd < last - 1) paginationList.push('...');
if (last > 1) paginationList.push(last);
---

<PageShell
  title={pageTitle}
  description={pageDescription}
  noindex={shouldNoindex}
  canonical={canonicalURL}
  prevURL={prevURL}
  nextURL={nextURL}
  transparentHeader={true}
>
  <Fragment slot="head">
    <style>
      .stats-wrapper {
        position: relative;
        min-height: 50vh;
      }

      .posts-container {
        background: var(--color-surface);
        border-radius: 16px;
        box-shadow: var(--shadow-card);
        padding: 2em;
      }

      .posts-container :global(.section-header) {
        display: flex;
        align-items: baseline;
        gap: 0.5em;
        margin-bottom: 0.5em;
      }

      .posts-container :global(.section-number) {
        font-size: 0.9em;
        color: var(--accent);
        font-weight: 600;
        opacity: 0.7;
      }

      .posts-container :global(.section-title) {
        font-size: 1.8em;
        font-weight: bold;
        margin: 0;
        color: var(--color-text);
        position: relative;
        display: inline-block;
      }

      .posts-container :global(.section-title)::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 2em;
        height: 3px;
        background: linear-gradient(90deg, var(--accent), transparent);
        border-radius: 3px;
      }

      .posts-container :global(.intro-text) {
        color: var(--color-text-secondary);
        margin-bottom: 2em;
        font-size: 0.9em;
        line-height: 1.6;
      }

      .blog-posts-list :global(.blog-post-item) {
        padding: 1.2em 1em;
        margin: 0 -1em;
        border-bottom: 1px solid var(--color-border-subtle);
        border-radius: 12px;
        position: relative;
        transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
      }

      .blog-posts-list :global(.blog-post-item:last-child) {
        border-bottom: none;
      }

      .blog-posts-list :global(.blog-post-item)::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%) scaleY(0);
        width: 3px;
        height: 60%;
        background: var(--accent);
        border-radius: 0 3px 3px 0;
        transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1);
      }

      .blog-posts-list :global(.blog-post-item:hover) {
        background: var(--color-surface-hover);
        box-shadow: var(--shadow-card-hover);
        transform: translateX(4px);
      }

      .blog-posts-list :global(.blog-post-item:hover)::before {
        transform: translateY(-50%) scaleY(1);
      }

      .blog-posts-list :global(.blog-post-title) {
        font-size: 1.4em;
        font-weight: 700;
        margin: 0 0 0.5em 0;
        color: var(--color-text);
      }

      .blog-posts-list :global(.blog-post-title a) {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s;
      }

      .blog-posts-list :global(.blog-post-title a:hover) {
        color: var(--accent);
      }

      .blog-posts-list :global(.blog-post-excerpt) {
        color: var(--color-text-secondary);
        font-size: 0.95em;
        line-height: 1.6;
        margin: 0 0 1em 0;
      }

      .blog-posts-list :global(.blog-post-meta) {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1em;
        font-size: 0.85em;
        color: var(--color-text-tertiary);
      }

      .blog-posts-list :global(.blog-post-meta-item) {
        display: flex;
        align-items: center;
        gap: 0.3em;
        padding: 2px 6px;
        border-radius: 4px;
      }

      .blog-posts-list :global(.blog-post-meta-item svg) {
        width: 14px;
        height: 14px;
      }

      .blog-posts-list :global(.blog-post-tags) {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
      }

      .blog-posts-list :global(.blog-tag-link) {
        display: inline-flex;
        align-items: center;
        gap: 0.2em;
        padding: 2px 8px;
        background: var(--color-tag-bg);
        color: var(--color-tag-text);
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.85em;
        transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        transform-origin: center;
      }

      .blog-posts-list :global(.blog-tag-link:hover) {
        background: var(--accent);
        color: white;
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 3px 8px rgba(var(--accent-rgb), 0.25);
      }

      .blog-posts-list :global(.blog-tag-link:active) {
        transform: translateY(0) scale(0.97);
      }

      .blog-posts-list :global(.blog-tag-link svg) {
        width: 12px;
        height: 12px;
      }

      @media (max-width: 900px) {
        .posts-container {
          padding: 1.5em;
        }

        .blog-posts-list :global(.blog-post-item) {
          margin: 0;
          padding: 1em 0.75em;
        }
      }

      @media (max-width: 720px) {
        .posts-container {
          padding: 1.2em;
          border-radius: 0;
        }

        .posts-container :global(.section-title) {
          font-size: clamp(1.45rem, 6vw, 1.7rem);
        }

        .blog-posts-list :global(.blog-post-title) {
          font-size: 1.2em;
        }

        .blog-posts-list :global(.blog-post-meta) {
          gap: 0.6em;
        }
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 3em;
        padding-top: 2em;
        border-top: 1px solid var(--color-border);
        gap: 1em;
      }

      .page-numbers {
        display: flex;
        align-items: center;
        gap: 0.5em;
        transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
      }

      .pagination:hover .page-numbers {
        transform: scale(1.02);
      }

      .page-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: transparent;
        color: var(--color-text-secondary);
        text-decoration: none;
        transition: transform 0.3s cubic-bezier(0.05, 0.7, 0.1, 1),
          box-shadow 0.3s cubic-bezier(0.05, 0.7, 0.1, 1) !important;
        font-weight: 500;
        font-size: 0.95em;
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
        transform-origin: center;
      }

      .page-btn::after {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--accent);
        opacity: 0;
        border-radius: inherit;
        transform: scale(0);
        transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1), opacity 0.3s cubic-bezier(0.05, 0.7, 0.1, 1);
      }

      .page-btn:hover:not(.disabled):not(.active)::after {
        transform: scale(1);
        opacity: 0.06;
      }

      .page-btn:hover:not(.disabled):not(.active) {
        color: var(--accent);
        transform: translateY(-3px) scale(1.05);
        transition: transform 0.25s cubic-bezier(0.05, 0.7, 0.1, 1),
          box-shadow 0.25s cubic-bezier(0.05, 0.7, 0.1, 1) !important;
      }

      .page-btn.active {
        background: var(--accent);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 16px rgba(var(--accent-rgb), 0.35);
        transform: scale(1.08);
        transition: all 0.4s cubic-bezier(0.2, 0, 0, 1);
      }

      .page-btn.disabled {
        opacity: 0.25;
        cursor: not-allowed;
        pointer-events: none;
        transition: opacity 0.3s cubic-bezier(0.3, 0, 0.8, 0.15);
      }

      .prev-btn:hover:not(.disabled),
      .next-btn:hover:not(.disabled) {
        transform: translateY(-3px) scale(1.05);
        transition: all 0.25s cubic-bezier(0.05, 0.7, 0.1, 1);
      }

      .prev-btn:active:not(.disabled) {
        transform: translateX(-4px) scale(0.95);
        transition: all 0.15s cubic-bezier(0.3, 0, 0.8, 0.15);
      }

      .next-btn:active:not(.disabled) {
        transform: translateX(4px) scale(0.95);
        transition: all 0.15s cubic-bezier(0.3, 0, 0.8, 0.15);
      }

      @media (max-width: 480px) {
        .pagination {
          gap: 0.5em;
          justify-content: flex-start;
          overflow-x: auto;
          padding-bottom: 0.4em;
        }

        .page-numbers {
          gap: 0.2em;
          flex-shrink: 0;
        }

        .page-btn {
          width: 32px;
          height: 32px;
          font-size: 0.85em;
        }
      }

      .scroll-reveal {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s cubic-bezier(0.05, 0.7, 0.1, 1), transform 0.6s cubic-bezier(0.05, 0.7, 0.1, 1);
      }

      .scroll-reveal.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .page-ellipsis {
        color: var(--color-text-muted);
        padding: 0 0.2em;
        font-size: 0.9em;
        animation: ellipsisPulse 1.8s cubic-bezier(0.2, 0, 0, 1) infinite;
        transition: all 0.3s cubic-bezier(0.05, 0.7, 0.1, 1);
      }

      .page-ellipsis:hover {
        color: var(--accent);
        transform: scale(1.2);
      }

      @keyframes ellipsisPulse {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(1);
        }

        50% {
          opacity: 1;
          transform: scale(1.05);
        }
      }
    </style>
  </Fragment>

  <HeroHeader
    text={blogHero.text}
    subtitle={blogHero.subtitle}
    backgroundImage={blogHero.backgroundImage}
    compact={true}
  />

  <div class="stats-wrapper">
    <ContentCard id="stats-card">
      <div class="posts-container">
        <SectionHeader
          number={`Page ${page.currentPage}`}
          title="所有文章"
          intro={hasPosts
            ? `这里收录了所有的 ${page.total} 篇文章 (第 ${page.currentPage} / ${page.lastPage} 页)`
            : '当前没有文章内容。请在 src/content/blog/ 添加 .md/.mdx 文件后重新构建。'}
        />

        <div class="blog-posts-list">
          {page.data.length > 0 ? (
            page.data.map((post) => (
              <div class="scroll-reveal">
                <PostListItem
                  post={post}
                  titleTag="h2"
                  articleClass="blog-post-item"
                  titleClass="blog-post-title"
                  excerptClass="blog-post-excerpt"
                  showExcerpt={true}
                  excerpt={extractExcerpt(post.body || '', 160)}
                  metaContainerClass="blog-post-meta"
                  metaItemClass="blog-post-meta-item"
                  metaTagsClass="blog-post-tags"
                  tagLinkClass="blog-tag-link hover-scale"
                />
              </div>
            ))
          ) : (
            <p class="blog-post-excerpt" style="text-align:center;padding:1.5em 0;">
              暂无文章。请在 <code>src/content/blog/</code> 添加内容后再查看此页。
            </p>
          )}
        </div>

        {page.lastPage > 1 && (
          <div class="pagination">
            <a href={page.url.prev || '#'} class={`page-btn prev-btn ${!page.url.prev ? 'disabled' : ''}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6" /></svg>
            </a>

            <div class="page-numbers">
              {paginationList.map((num) => {
                if (num === '...') {
                  return <span class="page-ellipsis">...</span>;
                }
                return (
                  <a href={num === 1 ? '/blog' : `/blog/${num}`} class={`page-btn ${page.currentPage === num ? 'active' : ''}`}>
                    {num}
                  </a>
                );
              })}
            </div>

            <a href={page.url.next || '#'} class={`page-btn next-btn ${!page.url.next ? 'disabled' : ''}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6" /></svg>
            </a>
          </div>
        )}
      </div>
    </ContentCard>
  </div>

  <Fragment slot="scripts">
    <script>
      import { runPageEnhancements } from '../../scripts/pages/registry';
      runPageEnhancements('blog-list');
    </script>
  </Fragment>
</PageShell>
