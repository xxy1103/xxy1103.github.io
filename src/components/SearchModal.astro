---
/**
 * SearchModal - 全站搜索模态框组件
 * 使用 Fuse.js 进行客户端全文搜索
 */
---

<!-- 搜索模态框 -->
<div id="search-modal" class="search-modal" aria-hidden="true" transition:name="search-modal" transition:persist>
    <div class="search-overlay"></div>
    <div class="search-container">
        <div class="search-header">
            <div class="search-input-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="搜索文章标题或内容..." 
                    autocomplete="off"
                    autofocus
                />
                <button id="search-close" class="search-close" aria-label="关闭搜索">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="search-results" id="search-results">
            <div class="search-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <p>输入关键词开始搜索</p>
            </div>
        </div>

        <div class="search-footer">
            <span class="search-hint">
                <kbd>↵</kbd> 跳转
                <kbd>ESC</kbd> 关闭
            </span>
        </div>
    </div>
</div>

<style>
    :root {
        /* Material Design easing (standard / decelerate / accelerate) */
        --md-ease-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
        --md-ease-decelerate: cubic-bezier(0.0, 0.0, 0.2, 1);
        --md-ease-accelerate: cubic-bezier(0.4, 0.0, 1, 1);
        --search-enter-duration: 300ms;
        --search-exit-duration: 320ms;
    }

    .search-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 5vh;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity var(--search-exit-duration) var(--md-ease-accelerate),
                    visibility 0s linear var(--search-exit-duration);
    }

    .search-modal.active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transition: opacity var(--search-enter-duration) var(--md-ease-decelerate);
    }

    .search-modal.closing {
        opacity: 0;
        visibility: visible;
        pointer-events: none;
        transition: opacity var(--search-exit-duration) var(--md-ease-accelerate);
    }

    .search-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        opacity: 0;
        transition: opacity var(--search-exit-duration) var(--md-ease-accelerate);
    }

    .search-modal.active .search-overlay {
        opacity: 1;
        transition: opacity var(--search-enter-duration) var(--md-ease-decelerate);
    }

    .search-modal.closing .search-overlay {
        opacity: 0;
        transition: opacity var(--search-exit-duration) var(--md-ease-accelerate);
    }

    .search-container {
        position: relative;
        width: 100%;
        max-width: 680px;
        max-height: 85vh;
        margin: 0 1em;
        background: var(--color-search-bg);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        /* Exit State */
        transform: translateY(-18px) scale(0.98);
        opacity: 0;
        transition:
            transform var(--search-exit-duration) var(--md-ease-accelerate),
            opacity var(--search-exit-duration) var(--md-ease-accelerate);
        overflow: hidden;
        will-change: transform, opacity;
    }

    .search-modal.active .search-container {
        /* Entrance State */
        transform: translateY(0) scale(1);
        opacity: 1;
        transition:
            transform var(--search-enter-duration) var(--md-ease-decelerate),
            opacity 260ms var(--md-ease-standard);
    }

    .search-modal.closing .search-container {
        transform: translateY(-12px) scale(0.99);
        opacity: 0;
        transition:
            transform var(--search-exit-duration) var(--md-ease-accelerate),
            opacity var(--search-exit-duration) var(--md-ease-accelerate);
    }

    .search-header {
        padding: 1.25em;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-search-bg);
        z-index: 10;
    }

    .search-input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75em;
        background: var(--color-surface-input);
        border-radius: 8px;
        padding: 0.85em 1em;
        border: 1px solid transparent;
        transition: all 0.2s;
    }

    .search-input-wrapper:focus-within {
        background: var(--color-search-bg);
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1);
    }

    .search-icon {
        color: var(--color-text-muted);
        flex-shrink: 0;
    }

    .search-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 1.1em;
        color: var(--color-text);
        outline: none;
    }

    .search-input::placeholder {
        color: var(--color-text-muted);
    }

    .search-close {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .search-close:hover {
        background: var(--color-tag-bg);
        color: var(--color-text-secondary);
    }

    .search-results {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        scroll-behavior: smooth;
    }

    :global(.search-placeholder) {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--color-text-muted);
        gap: 1em;
    }

    :global(.search-placeholder svg) {
        opacity: 0.3;
    }

    /* Search Result Item Styling - :global needed for dynamically generated content */
    :global(.search-result-item) {
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        padding: 1.25em 1.5em;
        text-decoration: none !important;
        color: var(--color-text) !important;
        transition: all 0.2s ease-in-out;
        border-left: 4px solid transparent; 
        border-bottom: 1px solid var(--color-border-subtle);
        background: var(--color-surface);
    }

    :global(.search-result-item:hover),
    :global(.search-result-item.focused) {
        background: var(--color-search-result-hover);
        border-left-color: var(--accent);
        padding-left: 1.8em;
    }

    :global(.search-result-title) {
        font-size: 1.1em;
        font-weight: 700;
        color: var(--color-text-strong) !important;
        line-height: 1.3;
    }
    
    :global(.search-result-title .search-highlight) {
        color: var(--color-search-highlight-text) !important;
    }

    :global(.search-result-excerpt) {
        font-size: 0.95em;
        color: var(--color-text-secondary) !important;
        line-height: 1.6;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        font-weight: 400;
    }

    /* Highlight matching text styling */
    :global(.search-highlight) {
        color: var(--color-search-highlight-text) !important;
        background: var(--color-search-highlight-bg);
        padding: 0 2px;
        border-radius: 2px;
        font-weight: 500;
    }

    :global(.search-no-results) {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 250px;
        color: var(--color-text-muted);
        gap: 0.75em;
    }

    .search-footer {
        padding: 0.75em 1.25em;
        border-top: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--color-search-footer-bg);
        color: var(--color-text-tertiary);
        font-size: 0.85em;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
    }

    /* Custom Scrollbar */
    .search-results::-webkit-scrollbar {
        width: 8px;
    }
    .search-results::-webkit-scrollbar-track {
        background: transparent;
    }
    .search-results::-webkit-scrollbar-thumb {
        background-color: var(--color-scrollbar);
        border-radius: 4px;
    }
    .search-results::-webkit-scrollbar-thumb:hover {
        background-color: var(--color-scrollbar-hover);
    }

    @media (max-width: 640px) {
        .search-modal {
            padding-top: 0;
            background: var(--color-search-bg);
        }
        .search-container {
            max-height: 100vh;
            max-height: 100dvh;
            height: 100vh;
            height: 100dvh;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }
        .search-header {
            padding: calc(0.85em + env(safe-area-inset-top)) 0.85em 0.85em;
            border-bottom: 1px solid var(--color-border);
        }
        .search-input-wrapper {
            padding: 0.75em 0.85em;
            gap: 0.5em;
        }
        .search-input {
            font-size: 16px;
        }
        .search-results {
            padding-bottom: calc(0.5em + env(safe-area-inset-bottom));
        }
        .search-footer {
            display: none;
        }
        :global(.search-result-item) {
            padding: 1.1em 0.95em;
            min-height: 84px;
        }
    }
</style>

<script>
import '../scripts/search-modal.client';
</script>
