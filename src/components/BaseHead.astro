---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import '../styles/global.css';
import { ViewTransitions } from 'astro:transitions';
import type { ImageMetadata } from 'astro';
import FallbackImage from '../assets/blog-placeholder-1.jpg';
import { enableCustomCursorByDefault, faviconIco, locale, siteTitle, siteUrl } from '../config';

type SchemaObject = Record<string, unknown>;

interface Props {
	title: string;
	description: string;
	image?: ImageMetadata | string;
	type?: 'website' | 'article';
	noindex?: boolean;
	publishedTime?: Date | string;
	modifiedTime?: Date | string;
	section?: string;
	tags?: string[];
	schema?: SchemaObject | SchemaObject[];
	canonical?: string | URL;
}

const siteURL = Astro.site ?? new URL(siteUrl);
const ogLocale = locale.replace('-', '_');

function normalizeDate(value?: Date | string) {
	if (!value) return undefined;
	const date = value instanceof Date ? value : new Date(value);
	return Number.isNaN(date.valueOf()) ? undefined : date.toISOString();
}

const {
	title,
	description,
	image = FallbackImage,
	type = 'website',
	noindex = false,
	publishedTime,
	modifiedTime,
	section,
	tags = [],
	schema,
	canonical,
} = Astro.props;

const canonicalURL = canonical
	? new URL(canonical.toString(), siteURL)
	: new URL(Astro.url.pathname, siteURL);
const pageURL = canonicalURL.toString();
const imageSrc = typeof image === 'string' ? image : image.src;
const imageURL = new URL(imageSrc, siteURL).toString();
const robotsContent = noindex
	? 'noindex,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1'
	: 'index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1';
const publishedTimeISO = normalizeDate(publishedTime);
const modifiedTimeISO = normalizeDate(modifiedTime);
const schemaList = !schema ? [] : Array.isArray(schema) ? schema : [schema];
---

<!-- Global Metadata -->
<meta charset="utf-8" transition:persist />
<meta name="viewport" content="width=device-width,initial-scale=1" transition:persist />
<meta name="custom-cursor-default" content={enableCustomCursorByDefault ? 'on' : 'off'} transition:persist />
<link rel="icon" href={faviconIco} sizes="any" transition:persist />
<link rel="sitemap" href="/sitemap-index.xml" transition:persist />
<link
	rel="alternate"
	type="application/rss+xml"
	title={siteTitle}
	href={new URL('rss.xml', siteURL)}
	transition:persist
/>
<meta name="generator" content={Astro.generator} transition:persist />

<!-- Theme initialization — prevents flash of wrong theme -->
<script is:inline transition:persist>
(function() {
  function getTheme() {
    const stored = localStorage.getItem('theme');
    if (stored) return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  // 首次加载立即应用
  document.documentElement.setAttribute('data-theme', getTheme());
  // View Transitions: 在 DOM 交换前将主题写入新文档，彻底消除闪烁
  document.addEventListener('astro:before-swap', (ev) => {
    ev.newDocument.documentElement.setAttribute('data-theme', getTheme());
  });
})();
</script>

<!-- Custom cursor switch (head-level) -->
<script is:inline transition:persist>
(() => {
  const STORAGE_KEY = 'custom-cursor-enabled';
  const defaultEnabled =
    document.querySelector('meta[name="custom-cursor-default"]')?.getAttribute('content') !== 'off';

  const parseStoredBoolean = (value) => {
    if (value === 'true') return true;
    if (value === 'false') return false;
    return null;
  };

  const applyCursorSwitch = (enabled, doc = document) => {
    const html = doc.documentElement;
    html.classList.toggle('custom-cursor-enabled', enabled);
    html.setAttribute('data-custom-cursor', enabled ? 'on' : 'off');
    if (!enabled) {
      html.classList.remove('custom-cursor-active');
    }
  };

  const storedValue = parseStoredBoolean(localStorage.getItem(STORAGE_KEY));
  const initialEnabled = storedValue === null ? defaultEnabled : storedValue;
  applyCursorSwitch(initialEnabled);
  window.__customCursorEnabled = initialEnabled;

  window.setCustomCursorEnabled = (nextEnabled) => {
    const enabled = Boolean(nextEnabled);
    localStorage.setItem(STORAGE_KEY, String(enabled));
    window.__customCursorEnabled = enabled;
    applyCursorSwitch(enabled);
    window.dispatchEvent(new CustomEvent('custom-cursor:toggle', { detail: { enabled } }));
    if (enabled && !window.cursorState) {
      window.location.reload();
    }
  };

  document.addEventListener('astro:before-swap', (ev) => {
    const enabled = window.__customCursorEnabled ?? initialEnabled;
    applyCursorSwitch(Boolean(enabled), ev.newDocument);
  });
})();
</script>

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="robots" content={robotsContent} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={pageURL} />
<meta property="og:site_name" content={siteTitle} />
<meta property="og:locale" content={ogLocale} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={imageURL} />
{type === 'article' && publishedTimeISO && (
	<meta property="article:published_time" content={publishedTimeISO} />
)}
{type === 'article' && modifiedTimeISO && (
	<meta property="article:modified_time" content={modifiedTimeISO} />
)}
{type === 'article' && section && <meta property="article:section" content={section} />}
{type === 'article' &&
	tags.map((tag) => <meta property="article:tag" content={tag} />)}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={pageURL} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={imageURL} />
{schemaList.map((item) => (
	<script type="application/ld+json" set:html={JSON.stringify(item)} />
))}

<!-- On Android, force full-page reload navigation -->
<script is:inline transition:persist>
(() => {
  const isAndroid = () => /Android/i.test(navigator.userAgent);
  const android = isAndroid();

  if (android) {
    document.documentElement.classList.add('is-android');
  } else {
    document.documentElement.classList.remove('is-android');
  }

  if (!android) return;

  const isReloadCandidate = (anchor) => {
    if (!anchor) return false;
    if (anchor.target && anchor.target.toLowerCase() !== '_self') return false;
    if (anchor.hasAttribute('download')) return false;

    const href = anchor.getAttribute('href');
    if (!href || href.startsWith('#')) return false;
    if (href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('javascript:')) {
      return false;
    }

    const nextURL = new URL(anchor.href, window.location.href);
    if (nextURL.origin !== window.location.origin) return false;
    return nextURL.href !== window.location.href;
  };

  document.addEventListener(
    'click',
    (event) => {
      if (!android) return;
      if (
        event.defaultPrevented ||
        event.button !== 0 ||
        event.metaKey ||
        event.ctrlKey ||
        event.shiftKey ||
        event.altKey
      ) {
        return;
      }

      const target = event.target;
      if (!(target instanceof Element)) return;

      const anchor = target.closest('a');
      if (!(anchor instanceof HTMLAnchorElement)) return;
      if (!isReloadCandidate(anchor)) return;

      event.preventDefault();
      window.location.assign(anchor.href);
    },
    { capture: true },
  );
})();
</script>

<!-- View Transitions -->
<ViewTransitions />

<style is:global>
  /* ============================================
   * Material Design 3 — Core Easing Curves
   * 
   * 1. Emphasized Decelerate: cubic-bezier(0.05, 0.7, 0.1, 1.0)
   *    → For entering/appearing elements (快速启动，缓慢着陆)
   *
   * 2. Emphasized Accelerate: cubic-bezier(0.3, 0.0, 0.8, 0.15)
   *    → For exiting/disappearing elements (慢速启动，快速离场)
   *
   * 3. Emphasized (Standard): cubic-bezier(0.2, 0.0, 0.0, 1.0)
   *    → For shared-axis / morphing transitions (柔和的全程过渡)
   * ============================================ */

  /* 页面退出动画 — Emphasized Accelerate: 缓慢拾起，迅速消失 */
  @keyframes md3SlideOut {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    30% {
      opacity: 1;
      transform: translateY(-2px) scale(1.005);
    }
    to {
      opacity: 0;
      transform: translateY(-30px) scale(0.97);
    }
  }
  
  /* 页面进入动画 — Emphasized Decelerate: 迅速到达，优雅着陆 */
  @keyframes md3SlideIn {
    from {
      opacity: 0;
      transform: translateY(40px) scale(0.97);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* 交叉淡入 — 用于 Hero 等共享元素 */
  @keyframes md3FadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }
  @keyframes md3FadeOut {
    from { opacity: 1; }
    to   { opacity: 0; }
  }
  
  /* ---- 主要内容区域过渡 ---- */
  ::view-transition-old(page-content) {
    animation: md3SlideOut 0.25s cubic-bezier(0.3, 0.0, 0.8, 0.15) forwards;
  }
  
  ::view-transition-new(page-content) {
    animation: md3SlideIn 0.4s cubic-bezier(0.05, 0.7, 0.1, 1.0) forwards;
  }

  /* Header 保持不动，不参与过渡动画 */
  ::view-transition-group(header) {
    animation: none;
    z-index: 100;
  }
  ::view-transition-old(header),
  ::view-transition-new(header) {
    animation: none;
  }

  /* SearchModal 保持不动 */
  ::view-transition-group(search-modal) {
    animation: none;
  }
  ::view-transition-old(search-modal),
  ::view-transition-new(search-modal) {
    animation: none;
  }

  /* ---- Hero 区域过渡 — Emphasized Standard ---- */
  ::view-transition-group(hero) {
    animation-duration: 0.5s;
    animation-timing-function: cubic-bezier(0.2, 0.0, 0.0, 1.0);
    z-index: 1;
    overflow: hidden;
  }

  ::view-transition-old(hero),
  ::view-transition-new(hero) {
    animation: none;
    mix-blend-mode: normal;
    object-fit: none;
    object-position: center; 
    height: 100%;
    width: 100%;
  }

  /* ---- 内容区域组过渡 — Emphasized Standard ---- */
  ::view-transition-group(page-content) {
    animation-duration: 0.5s;
    animation-timing-function: cubic-bezier(0.2, 0.0, 0.0, 1.0);
    z-index: 10;
  }
  
  /* 性能优化：推迟渲染视口外的图片 */
  .prose img {
    content-visibility: auto;
    contain-intrinsic-size: 1000px; /* 预估图片高度，减少布局抖动 */
  }
</style>
